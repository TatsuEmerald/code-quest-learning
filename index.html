<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeQuest Full App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        body { background: #0f172a; overflow: hidden; color: white; font-family: sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .neon-text { text-shadow: 0 0 10px rgba(34, 211, 238, 0.8); }
        .code-font { font-family: 'Fira Code', monospace; }
        textarea { resize: none; spellcheck: false; }
        .mascot-on-map { width: 130px; position: absolute; bottom: 52%; left: 50%; transform: translateX(-50%); z-index: 5; pointer-events: none; }
        .nav-btn { background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .nav-btn:hover { background: rgba(34, 211, 238, 0.3); border-color: cyan; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center">

    <div id="app-container" class="w-full flex items-center justify-center p-4"></div>

    <script>
        // ==========================================
        // DATA VAULT: BOOKS -> CHAPTERS -> LESSONS
        // ==========================================
        const CHAPTER_VAULT = {
            // BOOK 1: APPRENTICE
            1: { b: 1, ch: 1, title: "The Message", goal: "Hello World", explain: "Text is a 'String'." },
            2: { b: 1, ch: 1, title: "The Quotes", goal: "\"Hello World\"", explain: "Use quotes for words." },
            3: { b: 1, ch: 1, title: "The Shield", goal: "(\"Hello World\")", explain: "Parentheses hold data." },
            4: { b: 1, ch: 1, title: "The Voice", goal: "console.log(\"Hello World\")", explain: "Log makes it speak." },
            5: { b: 1, ch: 1, title: "EXAM 1", goal: "console.log(\"Hello World\")", type: "quiz", explain: "Type from memory." },
            6: { b: 1, ch: 2, title: "Values", goal: "10", explain: "Numbers need no quotes." },
            7: { b: 1, ch: 2, title: "Assignment", goal: "power = 10", explain: "'=' stores data." },
            8: { b: 1, ch: 2, title: "The Box", goal: "let power = 10", explain: "'let' creates a variable." },
            9: { b: 1, ch: 2, title: "Peeking", goal: "console.log(power)", explain: "Look inside variables." },
            10: { b: 1, ch: 2, title: "EXAM 2", goal: "let power = 10", type: "quiz", explain: "Store 10 in 'power'." },
            11: { b: 1, ch: 3, title: "Math +", goal: "power + 5", explain: "Add values." },
            12: { b: 1, ch: 3, title: "Math -", goal: "power - 2", explain: "Subtract values." },
            13: { b: 1, ch: 3, title: "Math *", goal: "power * 2", explain: "Multiply values." },
            14: { b: 1, ch: 3, title: "Update", goal: "power = 20", explain: "Change a box value." },
            15: { b: 1, ch: 3, title: "New Math", goal: "let total = 5 + 5", explain: "Save math results." },
            16: { b: 1, ch: 3, title: "Health", goal: "let health = 10 - 2", explain: "Create health." },
            17: { b: 1, ch: 3, title: "Damage", goal: "let damage = 5 * 2", explain: "Create damage." },
            18: { b: 1, ch: 3, title: "Mix", goal: "total = power + 5", explain: "Add vars + nums." },
            19: { b: 1, ch: 3, title: "Alchemist", goal: "final = power + total", explain: "Add two variables." },
            20: { b: 1, ch: 3, title: "EXAM 3", goal: "let final = power + 5", type: "quiz", explain: "Create final result." },
            21: { b: 1, ch: 4, title: "Evaluation", goal: "power > 5", explain: "Check if greater than." },
            22: { b: 1, ch: 4, title: "The Gate", goal: "if (power > 5)", explain: "'if' starts a decision." },
            23: { b: 1, ch: 4, title: "Truth", goal: "10 > 5", explain: "Evaluate as true." },
            24: { b: 1, ch: 4, title: "The Lie", goal: "1 > 10", explain: "Evaluate as false." },
            25: { b: 1, ch: 4, title: "Less Than", goal: "health < 5", explain: "Check if less than." },
            26: { b: 1, ch: 4, title: "Equality", goal: "power === 10", explain: "Check if exactly equal." },
            27: { b: 1, ch: 4, title: "Else", goal: "else", explain: "The 'wrong' path." },
            28: { b: 1, ch: 4, title: "Block {", goal: "{", explain: "Starts action list." },
            29: { b: 1, ch: 4, title: "Block }", goal: "}", explain: "Ends action list." },
            30: { b: 1, ch: 4, title: "CHAPTER 4 EXAM", goal: "if (power > 5)", type: "quiz", explain: "EXAM: Start a logic gate to check if power is greater than 5. Requirements: Use the 'if' keyword, parentheses (), and the '>' symbol." },
	    // --- CHAPTER 5: THE LOOP SPIRAL ---
            31: { b: 1, ch: 5, title: "The Repeat", goal: "for", explain: "To repeat code, we use the 'for' keyword. Type it to begin the loop training." },
            32: { b: 1, ch: 5, title: "The Counter", goal: "let i = 0", explain: "Loops need a counter. Create one named 'i' and set it to 0 using 'let'." },
            33: { b: 1, ch: 5, title: "The Limit", goal: "i < 10", explain: "A loop needs a stop sign. Write a comparison to check if 'i' is less than 10." },
            34: { b: 1, ch: 5, title: "The Step", goal: "i++", explain: "To count up, use 'i++'. This adds 1 to your counter every lap." },
            35: { b: 1, ch: 5, title: "The Header", goal: "for (let i = 0; i < 5; i++)", explain: "Combine them! Write a loop header: start at 0, stop before 5, count by 1s." },
            36: { b: 1, ch: 5, title: "Loop Body", goal: "{", explain: "Like 'if' gates, loops use an opening curly bracket '{' to start the action list." },
            37: { b: 1, ch: 5, title: "Loop Action", goal: "console.log(i)", explain: "Inside the loop, use your 'Voice' command to print the counter variable 'i'." },
            38: { b: 1, ch: 5, title: "Loop Closure", goal: "}", explain: "Use the closing curly bracket '}' to tell the computer the loop ends here." },
            39: { b: 1, ch: 5, title: "Safety Step", goal: "i++", explain: "If you don't increase 'i', the loop runs forever! Type the increment command again." },
            40: { b: 1, ch: 5, title: "CHAPTER 5 EXAM", goal: "for (let i = 0; i < 10; i++)", type: "quiz", explain: "EXAM: Write a loop header that repeats 10 times. Requirements: Use 'for', start 'i' at 0, check if 'i' is less than 10, and use 'i++'." },

            // --- CHAPTER 6: THE LOGIC ARRAY ---
            41: { b: 1, ch: 6, title: "The List", goal: "[ ]", explain: "An Array is a list. Use square brackets [ ] to create an empty list." },
            42: { b: 1, ch: 6, title: "Inventory", goal: "['Sword', 'Shield']", explain: "Lists hold items. Create a list with the strings 'Sword' and 'Shield' inside." },
            43: { b: 1, ch: 6, title: "Storing Lists", goal: "let items = ['A', 'B']", explain: "Create a variable named 'items' and store a list of ['A', 'B'] inside it." },
            44: { b: 1, ch: 6, title: "The Index", goal: "0", explain: "Computers count from 0. Type the number used to find the VERY FIRST item in a list." },
            45: { b: 1, ch: 6, title: "Grabbing", goal: "items[0]", explain: "To get an item, use the list name 'items' followed by index 0 in brackets [ ]." },
            46: { b: 1, ch: 6, title: "Length", goal: "items.length", explain: "To count a list, use the list name followed by '.length'." },
            47: { b: 1, ch: 6, title: "Push", goal: "items.push('Gold')", explain: "Add to a list! Use '.push' with the string 'Gold' in parentheses ( )." },
            48: { b: 1, ch: 6, title: "Pop", goal: "items.pop()", explain: "Remove the last item! Use the '.pop' command with empty parentheses ( )." },
            49: { b: 1, ch: 6, title: "Update List", goal: "items[0] = 'Axe'", explain: "Change item 0 to the string 'Axe' using the assignment operator '='." },
            50: { b: 1, ch: 6, title: "CHAPTER 6 EXAM", goal: "items[1]", type: "quiz", explain: "EXAM: Access the SECOND item in the list named 'items'. Requirement: Use brackets and the correct index number." },

            // --- CHAPTER 7: THE FUNCTION FORGE ---
            51: { b: 1, ch: 7, title: "The Spell", goal: "function", explain: "Functions are saved spells. Type 'function' to start defining one." },
            52: { b: 1, ch: 7, title: "Name", goal: "function go()", explain: "Name your function 'go' followed by empty parentheses ( )." },
            53: { b: 1, ch: 7, title: "Gate {", goal: "{", explain: "Functions use '{' to hold their actions. Type the opener." },
            54: { b: 1, ch: 7, title: "Action", goal: "console.log('X')", explain: "Inside the function, log the string 'X' to the console." },
            55: { b: 1, ch: 7, title: "Gate }", goal: "}", explain: "Close your function definition with the '}' bracket." },
            56: { b: 1, ch: 7, title: "The Call", goal: "go()", explain: "To use the spell, type the name 'go' followed by ( ). This is called 'calling' it." },
            57: { b: 1, ch: 7, title: "Reuse", goal: "go()", explain: "Call the 'go' function one more time to see it run again." },
            58: { b: 1, ch: 7, title: "Clean Code", goal: "function", explain: "Functions group actions. Type 'function' to remember its purpose." },
            59: { b: 1, ch: 7, title: "Top Down", goal: "function", explain: "Usually, we define functions at the top of our code. Type 'function' again." },
            60: { b: 1, ch: 7, title: "CHAPTER 7 EXAM", goal: "start()", type: "quiz", explain: "EXAM: Run a function named 'start'. Requirement: Use the name and the correct calling symbols." },

            // --- CHAPTER 8: THE PARAMETER BRIDGE ---
            61: { b: 1, ch: 8, title: "The Input", goal: "(name)", explain: "Parameters take data in. Type '(name)' as a placeholder." },
            62: { b: 1, ch: 8, title: "Multiple", goal: "(a, b)", explain: "Send two inputs by separating 'a' and 'b' with a comma inside ( )." },
            63: { b: 1, ch: 8, title: "Usage", goal: "console.log(a)", explain: "Inside a function, use the parameter 'a' by logging it (no quotes!)." },
            64: { b: 1, ch: 8, title: "Greet", goal: "function greet(n)", explain: "Define a function 'greet' that takes one parameter called 'n'." },
            65: { b: 1, ch: 8, title: "Send Data", goal: "greet('Hero')", explain: "Call 'greet' and pass the string 'Hero' inside the parentheses." },
            66: { b: 1, ch: 8, title: "Teleport", goal: "greet", explain: "The data moves from the call to the parameter. Type the name 'greet'." },
            67: { b: 1, ch: 8, title: "Flex", goal: "greet('User')", explain: "Call 'greet' again, but this time pass the string 'User'." },
            68: { b: 1, ch: 8, title: "Math In", goal: "function add(a, b)", explain: "Define function 'add' that takes two parameters: 'a' and 'b'." },
            69: { b: 1, ch: 8, title: "Math Call", goal: "add(5, 5)", explain: "Call 'add' and pass the numbers 5 and 5 inside." },
            70: { b: 1, ch: 8, title: "CHAPTER 8 EXAM", goal: "function cast(p)", type: "quiz", explain: "EXAM: Define a function named 'cast' that accepts one parameter named 'p'. Requirement: Use the function keyword and parentheses." },

            // --- CHAPTER 9: THE RETURN PORTAL ---
            71: { b: 1, ch: 9, title: "The Result", goal: "return", explain: "The 'return' keyword sends a value out of a function. Type it now." },
            72: { b: 1, ch: 9, title: "Hand-off", goal: "return x", explain: "Write a command to return the variable 'x'." },
            73: { b: 1, ch: 9, title: "The Exit", goal: "return", explain: "'return' also stops the function immediately. Type it again." },
            74: { b: 1, ch: 9, title: "Catching", goal: "let r = add(1, 1)", explain: "Store the result of add(1, 1) into a new variable called 'r'." },
            75: { b: 1, ch: 9, title: "Direct", goal: "return a + b", explain: "Inside a function, return the math result of 'a + b' directly." },
            76: { b: 1, ch: 9, title: "Truth Ret", goal: "return true", explain: "Write a command to return the boolean value 'true'." },
            77: { b: 1, ch: 9, title: "Check Ret", goal: "return", explain: "Return is the heart of logic. Type it one more time." },
            78: { b: 1, ch: 9, title: "Empty", goal: "undefined", explain: "If you don't return anything, the result is 'undefined'. Type it." },
            79: { b: 1, ch: 9, title: "If Return", goal: "if", explain: "You can use an 'if' gate to decide WHAT to return. Type 'if'." },
            80: { b: 1, ch: 9, title: "CHAPTER 9 EXAM", goal: "return p", type: "quiz", explain: "EXAM: Inside a function, send back the value of parameter 'p'. Requirement: Use the 'return' keyword." },

            // --- CHAPTER 10: MASTER REVIEW ---
            81: { b: 1, ch: 10, title: "Review 1", goal: "let e = 100", explain: "Create a variable 'e' and set it to 100." },
            82: { b: 1, ch: 10, title: "Review 2", goal: "e = e - 10", explain: "Subtract 10 from variable 'e' and save it back to 'e'." },
            83: { b: 1, ch: 10, title: "Review 3", goal: "let p = []", explain: "Create a variable 'p' and set it to an empty list [ ]." },
            84: { b: 1, ch: 10, title: "Review 4", goal: "p.push('G')", explain: "Add the string 'G' to the list 'p' using '.push'." },
            85: { b: 1, ch: 10, title: "Review 5", goal: "for (let i=0; i<3; i++)", explain: "Write a loop header that counts from 0 to 3." },
            86: { b: 1, ch: 10, title: "Review 6", goal: "if (e > 0)", explain: "Write an 'if' gate to check if 'e' is greater than 0." },
            87: { b: 1, ch: 10, title: "Review 7", goal: "function play()", explain: "Define a function named 'play' with no parameters." },
            88: { b: 1, ch: 10, title: "Review 8", goal: "function h(a)", explain: "Define a function 'h' that takes one parameter 'a'." },
            89: { b: 1, ch: 10, title: "Review 9", goal: "return h", explain: "Return the variable 'h' from a function." },
            90: { b: 1, ch: 10, title: "FINAL EXAM", goal: "console.log('Master')", type: "quiz", explain: "EXAM: Output the string 'Master' to the console. Requirement: Use your 'Voice' command." },

            // --- CHAPTER 11: DATA OBJECTS ---
            91: { b: 1, ch: 11, title: "Object", goal: "{ }", explain: "Objects group data. Use curly brackets { } to create an empty one." },
            92: { b: 1, ch: 11, title: "Key-Value", goal: "name: 'C'", explain: "Inside an object, pair the key 'name' with the value 'C' using a colon." },
            93: { b: 1, ch: 11, title: "Grouping", goal: "{ n: 'C', l: 1 }", explain: "Create an object with n: 'C' and l: 1 separated by a comma." },
            94: { b: 1, ch: 11, title: "Storage", goal: "let h = { hp: 100 }", explain: "Store an object { hp: 100 } into a variable named 'h'." },
            95: { b: 1, ch: 11, title: "Dot Access", goal: "h.hp", explain: "Access the 'hp' inside 'h' using 'h' followed by a dot '.' and 'hp'." },
            96: { b: 1, ch: 11, title: "Update Obj", goal: "h.hp = 90", explain: "Use dot notation and '=' to change h.hp to 90." },
            97: { b: 1, ch: 11, title: "Add Key", goal: "h.mp = 50", explain: "Add a new key 'mp' to object 'h' and set it to 50." },
            98: { b: 1, ch: 11, title: "Nested", goal: "h.s.atk", explain: "Access 'atk' inside 's' which is inside 'h' using dots." },
            99: { b: 1, ch: 11, title: "List Link", goal: "h.i = []", explain: "Set the key 'i' in object 'h' to an empty list [ ]." },
            100: { b: 1, ch: 11, title: "CHAPTER 11 EXAM", goal: "hero.hp", type: "quiz", explain: "EXAM: Access the value of 'hp' inside the 'hero' object. Requirement: Use dot notation." },

            // BOOK 2: JOURNEYMAN
            101: { b: 2, ch: 1, title: "Output Protocol", goal: "console.log('Online')", explain: "TASK: Use 'Voice' to output Online." }
        };

        // ==========================================
        // GAME ENGINE
        // ==========================================
        const firebaseConfig = { 
            apiKey: "AIzaSyAKbMQ9rNalDV6p0pJSpIy84EthjLeGwig", 
            authDomain: "codequest-c1da5.firebaseapp.com", 
            projectId: "codequest-c1da5", 
            storageBucket: "codequest-c1da5.firebasestorage.app", 
            messagingSenderId: "726116988970", 
            appId: "1:726116988970:web:e8681978587c9d36a3eb53" 
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); const db = firebase.firestore();
        let userData = { mascot: "", currentLevel: 1, coins: 0 }; let viewingLevel = 1;

        window.onload = () => { renderLogin(); };

        function renderLogin() {
            document.getElementById('app-container').innerHTML = `
                <div class="glass p-8 rounded-[2.5rem] text-center max-w-md w-full border-t-4 border-cyan-400">
                    <h1 class="text-5xl font-black mb-8 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-fuchsia-500 tracking-tighter">CodeQuest</h1>
                    <button onclick="login()" class="w-full bg-white text-slate-900 font-black py-4 rounded-2xl hover:scale-105 transition-all">CONTINUE</button>
                </div>`;
        }

        function login() {
            const p = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(p).then(res => {
                db.collection("users").doc(res.user.uid).get().then(doc => {
                    if (doc.exists && doc.data().setupComplete) {
                        userData = doc.data(); viewingLevel = userData.currentLevel; goToMap();
                    } else renderMascotChoice();
                });
            });
        }

        function renderMascotChoice() {
            document.getElementById('app-container').innerHTML = `
                <div class="text-center w-full max-w-4xl">
                    <h2 class="text-4xl font-black mb-8 uppercase tracking-widest">Select Partner</h2>
                    <div class="grid grid-cols-2 gap-8">
                        <div onclick="saveM('dragon')" class="glass p-6 rounded-[2rem] cursor-pointer hover:border-cyan-400 group">
                            <img src="dragon.png" class="w-64 mx-auto mb-4 group-hover:scale-110 transition-all"><p class="text-2xl font-black text-cyan-400">CINDER</p>
                        </div>
                        <div onclick="saveM('unicorn')" class="glass p-6 rounded-[2rem] cursor-pointer hover:border-fuchsia-400 group">
                            <img src="unicorn.png" class="w-64 mx-auto mb-4 group-hover:scale-110 transition-all"><p class="text-2xl font-black text-fuchsia-400">SPARKLE</p>
                        </div>
                    </div>
                </div>`;
        }

        function saveM(m) {
            userData.mascot = m; userData.currentLevel = 1; viewingLevel = 1;
            db.collection("users").doc(auth.currentUser.uid).set({ mascot: m, currentLevel: 1, coins: 0, setupComplete: true }, { merge: true }).then(goToMap);
        }

        function goToMap() {
            const l = CHAPTER_VAULT[viewingLevel] || { title: "SOON", ch: 1, b: 1 };
            const curB = l.b || 1;
            const curC = l.ch || 1;
            const rankNames = ["", "Apprentice", "Journeyman", "Master"];

            // Logic to find all levels in the SAME Book and SAME Chapter
            const chLevels = Object.keys(CHAPTER_VAULT).filter(k => 
                CHAPTER_VAULT[k].b === curB && CHAPTER_VAULT[k].ch === curC
            ).map(Number);

            const startLvl = Math.min(...chLevels);
            const totalInCh = chLevels.length;
            const currentPos = viewingLevel - startLvl + 1;
            const pct = (currentPos / totalInCh) * 100;

            document.getElementById('app-container').innerHTML = `
                <div class="relative w-full max-w-6xl aspect-video bg-contain bg-center bg-no-repeat rounded-[3rem] border-4 border-white/10 shadow-2xl overflow-hidden" style="background-image: url('map.png'); background-color: #0f172a;">
                    <img src="${userData.mascot}.png" class="mascot-on-map">
                    <div class="absolute inset-x-12 top-1/2 -translate-y-1/2 flex justify-between z-30 pointer-events-none">
                        <button onclick="viewDir(-1)" class="nav-btn ${viewingLevel > 1 ? 'pointer-events-auto' : 'opacity-0'} text-white">‚¨ÖÔ∏è</button>
                        <button onclick="viewDir(1)" class="nav-btn ${viewingLevel < userData.currentLevel ? 'pointer-events-auto' : 'opacity-0'} text-white">‚û°Ô∏è</button>
                    </div>
                    <div class="absolute bottom-0 left-0 w-full h-24 bg-slate-900/90 flex items-center px-12 justify-between z-20">
                        <div class="flex items-center gap-6">
                            <img src="${userData.mascot}.png" class="w-16 h-16 object-contain bg-cyan-500/10 rounded-full border border-cyan-400">
                            <div>
                                <p class="text-[10px] text-slate-500 font-bold uppercase">${rankNames[curB]} - CH ${curC} (${Math.round(pct)}%)</p>
                                <p class="text-2xl font-black">LVL ${viewingLevel}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-8">
                            <div class="text-2xl font-black text-yellow-400">üü° ${userData.coins || 0}</div>
                            <button onclick="startQuest()" class="bg-cyan-400 text-slate-900 px-10 py-4 rounded-full font-black">START</button>
                        </div>
                    </div>
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 translate-x-16 text-center z-30">
                        <div class="w-24 h-24 bg-cyan-500 rounded-full animate-bounce border-4 border-white flex items-center justify-center font-black text-4xl">${viewingLevel}</div>
                        <p class="mt-4 font-black neon-text uppercase tracking-widest">${l.title}</p>
                    </div>
                </div>`;
        }

        function viewDir(d) { viewingLevel += d; goToMap(); }

        function startQuest() {
            const l = CHAPTER_VAULT[viewingLevel];
            document.getElementById('app-container').innerHTML = `
                <div class="glass p-10 rounded-[3rem] w-full max-w-5xl flex flex-col gap-6 border-b-8 border-cyan-500">
                    <div class="flex justify-between items-start">
                        <div class="max-w-xl">
                            <span class="text-xs font-bold text-cyan-400 uppercase tracking-widest">Book ${l.b} | Ch ${l.ch}</span>
                            <h2 class="text-3xl font-black uppercase mb-4">${l.title}</h2>
                            <div class="p-6 bg-white/5 rounded-xl border-l-4 border-cyan-400 text-lg italic text-slate-200">"${l.explain}"</div>
                        </div>
                        <img src="${userData.mascot}.png" class="w-24">
                    </div>
                    <div class="grid grid-cols-2 gap-8">
                        <div>
                            <textarea id="ed" class="w-full h-48 bg-black/90 p-4 text-cyan-300 code-font text-lg rounded-2xl outline-none mb-4" placeholder="// Type solution here..."></textarea>
                            <button onclick="valid()" class="w-full bg-cyan-400 text-slate-900 font-black py-4 rounded-2xl">EXECUTE</button>
                        </div>
                        <div class="bg-white/5 rounded-[2rem] p-8 text-center flex flex-col justify-center border border-white/10">
                            <p class="text-xs font-bold text-slate-500 mb-4 uppercase tracking-widest">Requirement Status:</p>
                            <div id="status" class="text-slate-400 italic">Ready for input...</div>
                        </div>
                    </div>
                    <button onclick="goToMap()" class="text-slate-500 text-xs font-black uppercase mt-4">Exit</button>
                </div>`;
        }

        function valid() {
            const i = document.getElementById('ed').value.trim().replace(/\s/g, "");
            const g = CHAPTER_VAULT[viewingLevel].goal.replace(/\s/g, "");
            if (i === g) {
                if (viewingLevel === userData.currentLevel) {
                    db.collection("users").doc(auth.currentUser.uid).update({ currentLevel: viewingLevel + 1, coins: firebase.firestore.FieldValue.increment(100) }).then(() => {
                        userData.currentLevel++; viewingLevel++; userData.coins += 100; renderSuccess();
                    });
                } else goToMap();
            } else {
                document.getElementById('status').innerHTML = `<span class="text-red-400 font-bold tracking-tight uppercase text-xs">Logic Mismatch. Check your syntax.</span>`;
            }
        }

        function renderSuccess() {
            document.getElementById('app-container').innerHTML = `
                <div class="text-center">
                    <h1 class="text-9xl mb-6">üß†</h1>
                    <h2 class="text-5xl font-black uppercase neon-text">SUCCESS!</h2>
                    <button onclick="goToMap()" class="mt-10 bg-white text-slate-900 px-16 py-5 rounded-2xl font-black shadow-2xl">CONTINUE</button>
                </div>`;
        }
    </script>
</body>
</html>
