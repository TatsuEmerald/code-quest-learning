<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeQuest: Journeyman Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        body { background: #0f172a; overflow: hidden; color: white; font-family: sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .neon-text { text-shadow: 0 0 10px rgba(34, 211, 238, 0.8); }
        .code-font { font-family: 'Fira Code', monospace; }
        textarea { resize: none; spellcheck: false; }
        .mascot-on-map { width: 130px; position: absolute; bottom: 52%; left: 50%; transform: translateX(-50%); z-index: 5; pointer-events: none; }
        .nav-btn { background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; pointer-events: auto; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center">
    <div id="app-container" class="w-full flex items-center justify-center p-4"></div>
    <script>
        const CHAPTER_VAULT = {
            // BOOK 1: THE APPRENTICE (Levels 1-100)
            1: { b: 1, ch: 1, title: "The Message", goal: "Hello World", explain: "Type exactly: Hello World" },
            // ... Assume levels 2-100 are present in your local file ...

            // BOOK 2: THE JOURNEYMAN (The Spiral Begins)
            101: { 
                b: 2, ch: 1, title: "Output Protocol", goal: "console.log('Online')", 
                explain: "TASK: Use your 'Voice' command to output the word Online to the console. (Don't forget the quotes and parentheses!)" 
            },
            102: { 
                b: 2, ch: 1, title: "String Creation", goal: "'Crystal'", 
                explain: "TASK: The computer needs to see the word Crystal as data, not as a command. How do you wrap a word for the computer to understand?" 
            },
            103: { 
                b: 2, ch: 2, title: "Mana Storage", goal: "let mana = 50", 
                explain: "TASK: Create a new variable named mana and store the number 50 inside it." 
            },
            104: { 
                b: 2, ch: 2, title: "Variable Peek", goal: "console.log(mana)", 
                explain: "TASK: Show the contents of your mana box in the console. Do not use quotes, or you'll just print the word 'mana'!" 
            },
            105: { 
                b: 2, ch: 3, title: "Potion Math", goal: "mana + 25", 
                explain: "TASK: You found a potion! Write an evaluation that adds 25 to your current mana variable." 
            },
            106: { 
                b: 2, ch: 4, title: "Low Mana Check", goal: "mana < 10", 
                explain: "TASK: We need to know if it's time to run. Write a comparison that evaluates if mana is less than 10." 
            },
            107: { 
                b: 2, ch: 4, title: "Full Power Check", goal: "mana === 100", 
                explain: "TASK: Write a strict evaluation to check if your mana is exactly 100." 
            },
            108: { 
                b: 2, ch: 4, title: "The Mana Gate", goal: "if(mana > 20)", 
                explain: "TASK: Start an 'if' gate that only opens if mana is greater than 20." 
            },
            109: { 
                b: 2, ch: 5, title: "The Training Loop", goal: "for(let i=0; i<3; i++)", 
                explain: "TASK: Build a loop header that repeats exactly 3 times (starting at 0)." 
            },
            110: { 
                b: 2, ch: 6, title: "Loot Table", goal: "let loot = ['Gold', 'Gem']", 
                explain: "TASK: Create a list variable called loot containing the words Gold and Gem." 
            }
        };

        const firebaseConfig = { apiKey: "AIzaSyAKbMQ9rNalDV6p0pJSpIy84EthjLeGwig", authDomain: "codequest-c1da5.firebaseapp.com", projectId: "codequest-c1da5", storageBucket: "codequest-c1da5.firebasestorage.app", messagingSenderId: "726116988970", appId: "1:726116988970:web:e8681978587c9d36a3eb53" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); const db = firebase.firestore();
        let userData = { mascot: "", currentLevel: 1, coins: 0 }; let viewingLevel = 1;

        window.onload = () => { document.getElementById('app-container').innerHTML = `<div class="glass p-8 rounded-[2.5rem] text-center max-w-md w-full border-t-4 border-cyan-400"><h1 class="text-5xl font-black mb-8 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-fuchsia-500">CodeQuest</h1><button onclick="login()" class="w-full bg-white text-slate-900 font-black py-4 rounded-2xl">CONTINUE</button></div>`; };
        function login() { const p = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(p).then(res => { db.collection("users").doc(res.user.uid).get().then(doc => { if (doc.exists && doc.data().setupComplete) { userData = doc.data(); viewingLevel = userData.currentLevel; goToMap(); } else renderMascotChoice(); }); }); }
        function renderMascotChoice() { document.getElementById('app-container').innerHTML = `<div class="text-center w-full max-w-4xl"><h2 class="text-4xl font-black mb-8">SELECT PARTNER</h2><div class="grid grid-cols-2 gap-8"><div onclick="saveM('dragon')" class="glass p-6 rounded-[2rem] cursor-pointer"><img src="dragon.png" class="w-64 mx-auto mb-4"><p class="text-2xl font-black text-cyan-400">CINDER</p></div><div onclick="finishSetup('unicorn')" class="glass p-6 rounded-[2rem] cursor-pointer"><img src="unicorn.png" class="w-64 mx-auto mb-4"><p class="text-2xl font-black text-fuchsia-400">SPARKLE</p></div></div></div>`; }
        function saveM(m) { userData.mascot = m; userData.currentLevel = 1; viewingLevel = 1; db.collection("users").doc(auth.currentUser.uid).set({ mascot: m, currentLevel: 1, coins: 0, setupComplete: true }, { merge: true }).then(goToMap); }
        
        function goToMap() { 
            const l = CHAPTER_VAULT[viewingLevel] || { title: "SOON", ch: 0, b: 1 }; 
            const chLvl = Object.values(CHAPTER_VAULT).filter(x => x.ch === l.ch && x.b === l.b);
            const start = Math.min(...Object.keys(CHAPTER_VAULT).filter(k => CHAPTER_VAULT[k].ch === l.ch && CHAPTER_VAULT[k].b === l.b));
            const pct = ((viewingLevel - start + 1) / (chLvl.length || 1)) * 100;
            const rank = l.b === 1 ? "Apprentice" : "Journeyman";

            document.getElementById('app-container').innerHTML = `<div class="relative w-full max-w-6xl aspect-video bg-contain bg-center bg-no-repeat rounded-[3rem] border-4 border-white/10 shadow-2xl overflow-hidden" style="background-image: url('map.png'); background-color: #0f172a;"><img src="${userData.mascot}.png" class="mascot-on-map"><div class="absolute inset-x-12 top-1/2 -translate-y-1/2 flex justify-between z-30 pointer-events-none"><button onclick="viewDir(-1)" class="nav-btn ${viewingLevel > 1 ? 'pointer-events-auto' : 'opacity-0'}">‚¨ÖÔ∏è</button><button onclick="viewDir(1)" class="nav-btn ${viewingLevel < userData.currentLevel ? 'pointer-events-auto' : 'opacity-0'}">‚û°Ô∏è</button></div><div class="absolute bottom-0 left-0 w-full h-24 bg-slate-900/90 flex items-center px-12 justify-between z-20"><div class="flex items-center gap-6"><img src="${userData.mascot}.png" class="w-16 h-16 object-contain bg-cyan-500/10 rounded-full border border-cyan-400"><div><p class="text-[10px] text-slate-500 font-bold">${rank.toUpperCase()} - CH ${l.ch} (${Math.round(pct)}%)</p><p class="text-2xl font-black">LVL ${viewingLevel}</p></div></div><div class="flex items-center gap-8"><div class="text-2xl font-black text-yellow-400">üü° ${userData.coins || 0}</div><button onclick="startQuest()" class="bg-cyan-400 text-slate-900 px-10 py-4 rounded-full font-black">START</button></div></div><div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 translate-x-16 text-center z-30"><div class="w-24 h-24 bg-cyan-500 rounded-full animate-bounce border-4 border-white flex items-center justify-center font-black text-4xl">${viewingLevel}</div><p class="mt-4 font-black neon-text uppercase">${l.title}</p></div></div>`;
        }
        
        function viewDir(d) { viewingLevel += d; goToMap(); }
        
        function startQuest() { 
            const l = CHAPTER_VAULT[viewingLevel];
            document.getElementById('app-container').innerHTML = `<div class="glass p-10 rounded-[3rem] w-full max-w-5xl flex flex-col gap-6 border-b-8 border-cyan-500"><div class="flex justify-between items-start"><div class="max-w-xl"><span class="text-xs font-bold text-cyan-400">BOOK ${l.b} | CH ${l.ch}</span><h2 class="text-3xl font-black uppercase mb-4">${l.title}</h2><div class="p-6 bg-white/5 rounded-xl border-l-4 border-cyan-400 text-lg leading-relaxed">"${l.explain}"</div></div><img src="${userData.mascot}.png" class="w-24"></div><div class="grid grid-cols-2 gap-8"><div><textarea id="ed" class="w-full h-48 bg-black/90 p-4 text-cyan-300 code-font text-lg rounded-2xl outline-none mb-4" placeholder="// Build your solution here..."></textarea><button onclick="valid()" class="w-full bg-cyan-400 text-slate-900 font-black py-4 rounded-2xl">EXECUTE CODE</button></div><div class="bg-white/5 rounded-[2rem] p-8 text-center flex flex-col justify-center border border-white/10"><p class="text-xs font-bold text-slate-500 mb-4 uppercase tracking-widest">Requirement Status:</p><div id="status" class="text-slate-400 italic">Awaiting execution...</div></div></div><button onclick="goToMap()" class="text-slate-500 text-xs font-black uppercase mt-4">Exit to Map</button></div>`;
        }

        function valid() { 
            const i = document.getElementById('ed').value.trim().replace(/\s/g, "");
            const g = CHAPTER_VAULT[viewingLevel].goal.replace(/\s/g, "");
            if (i === g) {
                if (viewingLevel === userData.currentLevel) {
                    db.collection("users").doc(auth.currentUser.uid).update({ currentLevel: viewingLevel+1, coins: firebase.firestore.FieldValue.increment(100) }).then(() => { userData.currentLevel++; viewingLevel++; userData.coins+=100; renderSuccess(); });
                } else goToMap();
            } else {
                document.getElementById('status').innerHTML = `<span class="text-red-400">Logic Error: Your solution does not match the requirements. Check your syntax!</span>`;
            }
        }
        function renderSuccess() { document.getElementById('app-container').innerHTML = `<div class="text-center"><h1 class="text-9xl mb-6">üß†</h1><h2 class="text-5xl font-black uppercase neon-text">SUCCESS!</h2><p class="mt-4 text-slate-400">Rank Progressing...</p><button onclick="goToMap()" class="mt-10 bg-white text-slate-900 px-16 py-5 rounded-2xl font-black">CONTINUE</button></div>`; }
    </script>
</body>
</html>
